<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.effiu.cn","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"path":"search.xml"};
  </script>

  <meta name="description" content="effiu的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="effiu&#39;s blog">
<meta property="og:url" content="https://www.effiu.cn/page/9/index.html">
<meta property="og:site_name" content="effiu&#39;s blog">
<meta property="og:description" content="effiu的博客">
<meta property="og:locale">
<meta property="article:author" content="effiu">
<meta property="article:tag" content="effiu&#39;s blog">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.effiu.cn/page/9/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>effiu's blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">effiu's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">生活不止眼前的苟且，还有诗和远方的田野</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/blog/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="effiu"
      src="/blog/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">effiu</p>
  <div class="site-description" itemprop="description">effiu的博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">85</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://www.effiu.cn/2019/04/13/concurrent/chapter2/2.3_atomic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="effiu">
      <meta itemprop="description" content="effiu的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="effiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/04/13/concurrent/chapter2/2.3_atomic/" class="post-title-link" itemprop="url">原子操作的实现原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-13 16:47 16:47:00" itemprop="dateCreated datePublished" datetime="2019-04-13T16:47:00+08:00">2019-04-13 16:47</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-02 00:54 00:54:36" itemprop="dateModified" datetime="2019-09-02T00:54:36+08:00">2019-09-02 00:54</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrent/" itemprop="url" rel="index"><span itemprop="name">concurrent</span></a>
                </span>
            </span>

          
            <span id="/blog/2019/04/13/concurrent/chapter2/2.3_atomic/" class="post-meta-item leancloud_visitors" data-flag-title="原子操作的实现原理" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原子(atomic)，指不能被分割的最小粒子。原子操作(atomic operation)指不可被中断的一个或者一系列操作。Intel处理器和Java实现原子操作原理如下：</p>
</blockquote>
<h6 id="1-CPU术语定义"><a href="#1-CPU术语定义" class="headerlink" title="1. CPU术语定义"></a>1. CPU术语定义</h6><table>
<thead>
<tr>
<th>术语名称</th>
<th>英文</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>缓存行</td>
<td>Cache line</td>
<td>缓存的最小操作单位</td>
</tr>
<tr>
<td>比较并交换</td>
<td>Compare and Swap</td>
<td>CAS操作需要输入两个数值，一个旧值和一个新值，在操作期间先比较旧值是否发生变化，没有变化才会换成新值，发生变化了则不交换</td>
</tr>
<tr>
<td>CPU流水线</td>
<td>CPU pipeline</td>
<td>CPU流水线像工业生产上的装配流水线。CPU中由5<del>6个不同功能的电路单元组成一条指令处理流水线，然后将一条x86指令分成5</del>6步由这些电路单元分别执行，这样可以在CPU一个时钟周期内完成一条指令，提高了CPU运算速度</td>
</tr>
<tr>
<td>内存顺序冲突</td>
<td>Memory order violation</td>
<td>内存顺序冲突一般由假共享引起。假共享是指多个CPU同时修改同一个缓存行的不同部分引起其中一个CPU操作无效，当出现这个内存顺序冲突时，CPU必须清空流水线</td>
</tr>
</tbody></table>
<h6 id="2-处理器如何保证原子操作"><a href="#2-处理器如何保证原子操作" class="headerlink" title="2. 处理器如何保证原子操作"></a>2. 处理器如何保证原子操作</h6><blockquote>
<p>32位IA-32处理器使用基于对缓存加锁或总线加锁的方式来实现多处理器之间的原子操作。首先处理器会自动保证基本的内存操作的原子性，指处理器读取一个字节时，其他处理器不能访问这个字节内存地址。复杂的内存操作处理器是不能自动保证原子性的，比如跨总线宽度、跨多个缓存行和跨页表的访问。为此，处理器提供了总线锁定和缓存锁定两个机制保证复杂内存操作的原子性。</p>
</blockquote>
<ol>
<li><p>使用总线保证原子性</p>
<blockquote>
<p>多个处理器同时对共享变量进行读写改操作（例如，i++操作），那么共享变量就会被多个处理器同时进行操作，这样操作就是非原子性的，可能出现共享变量的值和期望值不一样。总线锁是使用处理器提供的一个**LOCK#**信号，当一个处理器在总线上输出此信号时，其他处理器请求将被阻塞住，使改处理器独享内存</p>
</blockquote>
</li>
<li><p>缓存锁保证原子性</p>
<blockquote>
<p>为了保证原子性，我们只需要保证对某个内存地址的操作是原子性即可。而总线开销比较大，因为<strong>LOCK#**把CPU和内存之间的通信锁住了，锁住期间处理器不能操作其他内存地址的数据，所以使用</strong>缓存锁定**代替总线锁定进行优化。</p>
</blockquote>
<blockquote>
<p><strong>缓存一致性机制</strong>会阻止同时修改由两个以上处理器缓存的内存区域数据。</p>
<p><strong>缓存锁定</strong>指的是内存区域如果被缓存在处理器的缓存行中，由于缓存一致性机制不能存在两个处理器同时修改处理器缓存的内存区域，那么在LOCK期间会被锁定，当它执行锁操作回写到内存时，处理器不能在总线上声言**LOCK#**信号，而是修改内部的内存地址，当其他处理器回写被锁定的缓存行的数据时，会使缓存行无效。如下图所示，当CPU1修改缓存行中的i时会使用缓存锁定，那么CPU2就不能同时缓存i的缓存行。</p>
</blockquote>
<p><img src="https://images.effiu.cn/gitbook/concurrent/05.jpg" alt="缓存锁定"></p>
<blockquote>
<p>有两种情况处理器不会使用缓存锁定，会直接使用总线锁定</p>
</blockquote>
<ul>
<li>当操作的数据不能缓存在处理器内部或者数据库跨多个缓存行时</li>
<li>处理器不支持缓存锁定</li>
</ul>
</li>
</ol>
<h6 id="3-Java如何实现原子操作"><a href="#3-Java如何实现原子操作" class="headerlink" title="3. Java如何实现原子操作"></a>3. Java如何实现原子操作</h6><blockquote>
<p>Java可以通过<strong>锁</strong>和<strong>循环CAS</strong>的方式来实现原子操作</p>
</blockquote>
<ol>
<li><p>JVM中的CAS操作是利用了处理器提供的<strong>CMPXCHG</strong>指令实现的。<strong>自旋CAS</strong>实现的基本思路就是进行CAS操作直到成功为止。</p>
<blockquote>
<p>JDK的并发包里面提供了一些类支持原子操作，例如<code>AtomicBoolean</code>、<code>AtomicInteger</code>、<code>AtomicLong</code>等。<a target="_blank" rel="noopener" href="https://dev.tencent.com/u/effiu/p/essay-project/git/blob/master/src/main/java/com/effiu/essay/concurrent/learn/chapter2/Counter.java">代码见</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Counter cas = <span class="keyword">new</span> Counter();</span><br><span class="line"></span><br><span class="line">        List&lt;Thread&gt; threadList = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">600</span>);</span><br><span class="line">        <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">100</span>; j++) &#123;</span><br><span class="line"></span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                cas.count();</span><br><span class="line">                cas.safeCount();</span><br><span class="line">            &#125;);</span><br><span class="line">            threadList.add(t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        threadList.stream().forEach(p -&gt; p.start());</span><br><span class="line">        <span class="comment">//等待所有的线程执行完成</span></span><br><span class="line">        <span class="keyword">for</span> (Thread t : threadList) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 非线程安全计数器结果值不唯一</span></span><br><span class="line">        System.out.println(cas.i);</span><br><span class="line">        <span class="comment">// 计数结果是100</span></span><br><span class="line">        System.out.println(cas.atomicInteger.get());</span><br><span class="line">        System.out.println(System.currentTimeMillis() - l);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 非线程安全计数器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用CAS实现线程安全计数器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">safeCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = atomicInteger.get();</span><br><span class="line">            <span class="keyword">boolean</span> b = atomicInteger.compareAndSet(i, i + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (b) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>CAS实现原子操作存在3个问题</p>
<ol>
<li><strong>ABA问题</strong>，CAS操作需要在操作值的时候，检查值有没有发生变化，没有发生变化则更新。</li>
</ol>
<blockquote>
<p>CAS操作会产生一个问题.ABA问题，即A-&gt;B-&gt;A，CAS检查不出这种操作。其解决思路是使用版本号，在变量前面加上版本号。即1A-&gt;2B-&gt;3A。<code>java.util.concurrent.atomic.AtomicStampedReference</code>类解决ABA问题，<code>java.util.concurrent.atomic.AtomicStampedReference#compareAndSet</code>方法作用是首先检查当前引用是否等于预期引用，然后检查当前标志是否等于预期标志，只有全部相等，才能以原子的方式修改引用与标志。</p>
</blockquote>
<ol start="2">
<li>循环时间长开销大</li>
</ol>
<blockquote>
<p>CAS自旋长时间不成功，会给CPU带来非常大的执行开销。JVM能支持处理器提供的<strong>pause</strong>指令，使效率有一定的提升。<strong>pause</strong>指令有两个作用：</p>
</blockquote>
<ul>
<li>延迟流水线执行指令，使CPU不会消耗过多执行资源。</li>
<li>避免在退出循环的时候因为内存顺序冲突而引起CPU流水线被清空，从而提高CPU的执行资源。</li>
</ul>
<ol start="3">
<li>只能保证一个共享变量的原子操作</li>
</ol>
<blockquote>
<p>对多个共享变量操作时，循环CAS无法保证操作的原子性。可以使用<strong>锁</strong>或者把多个共享变量合并成一个共享变量来操作。<code>java.util.concurrent.atomic.AtomicReference</code>保证引用对象之间的原子性，可以把多个变量放在一个对象里进行CAS操作。</p>
</blockquote>
</li>
<li><p>锁机制实现原子操作</p>
<blockquote>
<p><strong>锁机制保证了只有获得锁的线程才能够操作锁定的区域</strong>。JVM内部实现了多种锁机制。例如<strong>偏向锁、轻量级锁、重量级锁</strong>，除了偏向锁，JVM实现锁的方式都使用了循环CAS，即线程获得锁和释放锁时都是用循环CAS机制。</p>
</blockquote>
</li>
</ol>
<h6 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h6><blockquote>
<p>介绍了<code>volatile</code>、<code>synchronized</code>和原子操作的实现原理。Java中的大部分容器和框架都依赖于本章介绍的<code>volatile</code>和原子操作的实现原理</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://www.effiu.cn/2019/04/09/concurrent/chapter2/2.2_synchronized/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="effiu">
      <meta itemprop="description" content="effiu的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="effiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/04/09/concurrent/chapter2/2.2_synchronized/" class="post-title-link" itemprop="url">synchronized</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-09 11:14 11:14:00" itemprop="dateCreated datePublished" datetime="2019-04-09T11:14:00+08:00">2019-04-09 11:14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-02 00:54 00:54:36" itemprop="dateModified" datetime="2019-09-02T00:54:36+08:00">2019-09-02 00:54</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrent/" itemprop="url" rel="index"><span itemprop="name">concurrent</span></a>
                </span>
            </span>

          
            <span id="/blog/2019/04/09/concurrent/chapter2/2.2_synchronized/" class="post-meta-item leancloud_visitors" data-flag-title="synchronized" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>Java SE 1.6对<code>synchronized</code>进行了各种优化，本文介绍了Java SE 1.6中为了减少获得锁和释放锁带来的性能消耗而引入的偏向锁和轻量级锁，以及锁的存储结构和升级过程。</p>
</blockquote>
<h6 id="1-synchronized-发音-sɪŋkrənaɪzd"><a href="#1-synchronized-发音-sɪŋkrənaɪzd" class="headerlink" title="1. synchronized 发音 [sɪŋkrənaɪzd]"></a>1. synchronized 发音 [sɪŋkrənaɪzd]</h6><blockquote>
<p><code>synchronized</code>实现同步的基础：Java中每个对象都可以作为锁，具体表现为3种形式：</p>
</blockquote>
<ul>
<li>对于普通同步方法，锁是当前实例对象。</li>
<li>对于静态同步方法，锁是当前<strong>Class</strong>对象</li>
<li>对于同步方法块，锁是<code>Synchronized</code>括号里配置的对象</li>
</ul>
<blockquote>
<p>当一个线程试图访问同步代码块时，必须先得到锁，退出或者抛出异常必须释放锁。</p>
<p><code>Synchronized</code>在JVM里的实现原理，JVM基于进入和退出<strong>Monitor</strong>对象来实现方法同步和代码块同步，但是实现细节不一样。代码块同步是使用<code>monitorenter</code>和<code>monitorexit</code>指令实现，而方法的同步是使用另外一种方式实现的。</p>
<p><code>monitorenter</code>指令是在编译后插入到同步代码块的开始位置，<code>monitorexit</code>是插入到方法结束处和异常处，JVM要保证每个<code>monitorenter</code>必须有对应的<code>monitorexit</code>与之配对。任何对象都有一个<code>monitor</code>与之关联，当一个<code>monitor</code>被持有后，它将处于锁定状态。线程执行到<code>monitorenter</code>时，会尝试获取对象所对应的<code>monitor</code>所有权，即尝试获得对象锁。</p>
</blockquote>
<h6 id="2-Java对象头"><a href="#2-Java对象头" class="headerlink" title="2. Java对象头"></a>2. Java对象头</h6><blockquote>
<p><code>synchronized</code>用的锁是存在Java对象头里的。如果对象是数组类型，则虚拟机用3个字宽(Word)存储对象头，若非数组类型，则用2个字宽存储对象头。</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">长度</th>
<th>内容</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">32/64bit</td>
<td>Mark Word</td>
<td>存储对象的hashCode、分代年龄和锁标记位</td>
</tr>
<tr>
<td align="center">32/64bit</td>
<td>Class Metadata Address</td>
<td>存储到对象的类型数据的指针</td>
</tr>
<tr>
<td align="center">32/64bit</td>
<td>Array length</td>
<td>数组的长度(如果当前对象是数组)</td>
</tr>
</tbody></table>
<blockquote>
<p>Java对象头里的<strong>Mark Word</strong>的存储结构</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">锁状态</th>
<th align="center">25bit</th>
<th align="center">4bit</th>
<th align="center">1bit是否偏向锁</th>
<th align="center">2bit锁标志位</th>
</tr>
</thead>
<tbody><tr>
<td align="center">无锁状态</td>
<td align="center">对象的hashCode</td>
<td align="center">对象分代年龄</td>
<td align="center">0</td>
<td align="center">01</td>
</tr>
</tbody></table>
<blockquote>
<p>运行期间<strong>Mark Word</strong>里存储的数据会随着标志位的变化而变化，如下图:</p>
</blockquote>
<p><img src="https://images.effiu.cn/gitbook/concurrent/01.jpg" alt="Mark Word变化"></p>
<blockquote>
<p>64位虚拟机下，Mark Word是64位大小，存储结构如下:</p>
</blockquote>
<p><img src="https://images.effiu.cn/gitbook/concurrent/02.jpg" alt="Mark Word存储结构"></p>
<h6 id="3-锁的升级与对比"><a href="#3-锁的升级与对比" class="headerlink" title="3. 锁的升级与对比"></a>3. 锁的升级与对比</h6><blockquote>
<p>Java SE 1.6中为了减少获得锁和释放锁带来的性能消耗，引入的“偏向锁”和“轻量级锁”，锁共有四种状态，级别从高到低依次是<strong>无锁状态</strong>、<strong>偏向锁状态</strong>、<strong>轻量级锁</strong>、<strong>重量级锁</strong>，会随着竞争情况逐渐升级。锁可以升级但不能降级，这种锁升级却不能降级的策略，目的是为了提高获得锁和释放锁的效率。</p>
</blockquote>
<ol>
<li><p>偏向锁</p>
<ul>
<li><input disabled="" type="checkbox"> CAS 算法原理</li>
</ul>
<blockquote>
<p>大多数情况下，锁不仅不存在多线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低而引入了偏向锁。当一个线程访问同步块并获取锁时，会在对象头和栈帧中记录并存储偏向锁的线程ID，以后该线程在进入和退出同步块时不需要进行CAS操作来加锁和解锁，只需要简单验证下对象头的Mark Word里是否存储着指向当前线程的偏向锁，验证成功，则说明已经获得了锁；验证失败，则需要在验证下Mark Word 中偏向锁的标识是否设置成1(表示当前是偏向锁)；若没有则使用CAS竞争锁；若设置了，则使用CAS将对象头的偏向锁指向当前线程</p>
</blockquote>
<ol>
<li><p>偏向锁的撤销</p>
<blockquote>
<p>偏向锁使用了一种等到竞争出现才会释放所的机制。偏向锁的撤销，需要等待全局安全点（在这个时间点上没有正在执行的字节码）。它会首先暂停拥有偏向锁的线程，然后检查持有偏向锁的线程是否活着，若线程不处于活动状态，则将对象头设置成无锁状态；若线程仍活着，则拥有偏向锁的栈会被执行，遍历偏向对象的锁记录，栈中的锁记录和对象头的Mark Word要么重新偏向于其他线程，要么恢复到无锁状态或者标记对象不适合作为偏向锁，最后唤醒暂停的线程</p>
</blockquote>
</li>
</ol>
<p><img src="https://images.effiu.cn/gitbook/concurrent/04.jpg" alt="偏向锁的获得和插销流程"></p>
<ol start="2">
<li><p>关闭偏向锁</p>
<blockquote>
<p>如果偏向锁在Java 6和Java 7是默认启用的，默认是在程序启动几秒钟后才能激活，可以使用JVM参数关闭延迟</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:biasedLockingStartupDelay=0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>若确定应用程序所有锁通常处于竞争状态，通过JVM参数关闭偏向锁，这样程序会默认进入轻量级锁状态</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:UseBiasedLocking=false</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>轻量级锁</p>
<ol>
<li><p>轻量级锁加锁</p>
<blockquote>
<p>线程执行同步块之前，JVM会先在当前线程的栈帧中创建用于存储锁记录的空间，并将对象头中的<strong>Mark Word</strong>复制到锁记录中，然后线程尝试使用CAS将对象头中的**Mark Word(Displaced Mark Word)**替换为指向锁记录的指针，成功则说明线程获得锁；失败表示其他线程竞争锁，当前线程便尝试使用自旋获取锁</p>
</blockquote>
</li>
<li><p>轻量级锁解锁</p>
<blockquote>
<p>轻量级锁解锁时，会使用原子的CAS操作将<strong>Displaced Mark Word</strong>替换回到对象头，如果成功则表示没有竞争发生，若失败锁就会膨胀成重量级锁。</p>
</blockquote>
<p><img src="https://images.effiu.cn/gitbook/concurrent/03.jpg" alt="轻量级锁及膨胀流程图"></p>
<blockquote>
<p>自旋会消耗CPU，所以为了避免无用的自旋，一旦锁升级成重量级锁，就不会恢复成轻量级锁，锁在这个状态下，其他线程试图获取锁时，会被阻塞住，当持有锁的线程释放所之后会唤醒这些线程，被唤醒的线程进入到新一轮竞争中</p>
</blockquote>
</li>
<li><p>锁的优缺点对比</p>
</li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>锁</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>偏向锁</td>
<td>加锁和解锁不需要额外的消耗，和执行非同步方法相比仅存在纳秒级的差距</td>
<td>如果线程间存在所得竞争，会带来额外的锁撤销的消耗</td>
<td>适用于只有一个线程访问同步块的场景</td>
</tr>
<tr>
<td>轻量级锁</td>
<td>竞争的线程不会阻塞，提高了程序的相应速度</td>
<td>如果始终得到不锁竞争的线程，使用自旋会消耗CPU追求响应时间</td>
<td>同步块执行速度非常快</td>
</tr>
<tr>
<td>重量级锁</td>
<td>线程竞争不使用自旋，不会消耗CPU</td>
<td>线程阻塞，响应时间缓慢</td>
<td>追求吞吐量，同步块执行速度较长</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://www.effiu.cn/2019/04/07/concurrent/chapter2/2.1_volatile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="effiu">
      <meta itemprop="description" content="effiu的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="effiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/04/07/concurrent/chapter2/2.1_volatile/" class="post-title-link" itemprop="url">volatile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-07 23:59 23:59:00" itemprop="dateCreated datePublished" datetime="2019-04-07T23:59:00+08:00">2019-04-07 23:59</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-02 00:54 00:54:36" itemprop="dateModified" datetime="2019-09-02T00:54:36+08:00">2019-09-02 00:54</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrent/" itemprop="url" rel="index"><span itemprop="name">concurrent</span></a>
                </span>
            </span>

          
            <span id="/blog/2019/04/07/concurrent/chapter2/2.1_volatile/" class="post-meta-item leancloud_visitors" data-flag-title="volatile" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 id="1-volatile-ˈvɑ-lətl-的定义与实现原理"><a href="#1-volatile-ˈvɑ-lətl-的定义与实现原理" class="headerlink" title="1. volatile[ˈvɑ:lətl]的定义与实现原理"></a>1. volatile[ˈvɑ:lətl]的定义与实现原理</h6><blockquote>
<p><code>volatile</code>是轻量级的<code>synchronized</code>[sɪŋkrənaɪzd]，在多处理器并发中保证了共享变量的“可见性”。“可见性”指的是当一个线程修改另一个共享变量时，另一个线程可以读到这个修改的值。使用恰当的话，比<code>synchronized</code>成本低，因为不会引起线程上下文的切换和调度。</p>
</blockquote>
<blockquote>
<p>Java编程语言允许线程访问共享变量，为了确保共享变量被准确和一致地更新，线程应该确保通过排他锁单独获得这个变量。如下是<code>volatile</code>实现原理相关的CPU术语与说明</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">术语</th>
<th align="left">英文单词</th>
<th align="left">术语描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">内存屏障</td>
<td align="left">memory barriers[‘bærɪrz]</td>
<td align="left">是一组处理器指令，用户实现对内存操作的顺序限制</td>
</tr>
<tr>
<td align="left">缓存行</td>
<td align="left">cache line</td>
<td align="left">CPU高速缓存中可以分配最小的存储单位。处理器填写缓存行时会加载整个缓存行，现代CPU需要执行几百次CPU指令</td>
</tr>
<tr>
<td align="left">原子操作</td>
<td align="left">atomic operation</td>
<td align="left">不可中断的一个或者一系列操作</td>
</tr>
<tr>
<td align="left">缓存行填充</td>
<td align="left">cache line fill</td>
<td align="left">当处理器识别到从内存中读取操作数是可缓存的，处理器读取整个高速缓存行到适当的缓存(L1,L2,L3或所有)</td>
</tr>
<tr>
<td align="left">缓存命中</td>
<td align="left">cache hit</td>
<td align="left">如果进行高速缓存行填充操作的内存位置仍然是下次处理器访问的地址时，处理器从缓存中读取操作数，而不是从内存读取</td>
</tr>
<tr>
<td align="left">写命中</td>
<td align="left">write hit</td>
<td align="left">当处理器将操作数写回到一个内存缓存的区域时，它首先会检查这个缓存的内存地址是否在缓存行中，如果存在一个有效的缓存行，则处理器将这个操作数写回到缓存，而不是写回到内存</td>
</tr>
<tr>
<td align="left">写缺失</td>
<td align="left">write misses the cache</td>
<td align="left">一个有效的缓存行被写入到不存在的内存区域</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> instance = <span class="keyword">new</span> Singleton();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>转变成汇编语言如下:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x01a3deld: movb $0x0,0x1104800(%esi);</span><br><span class="line">0x01a3de24: lock addl $ 0x0,(%esp);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>volatile</code>变量修饰的共享变量进行写操作时会多出第二行代码，<code>Lock</code>的前缀指令在多核处理器中操作如下:</p>
</blockquote>
<ul>
<li>将当前处理器缓存行的数据写回到系统内存</li>
<li>这个写回内存的操作会使在其他CPU里缓存了该内存地址的数据无效</li>
</ul>
<blockquote>
<p>为了提高处理速度，处理器不直接和内存进行通信，而是先将系统内存的数据读到内部缓存后再进行操作，但操作完不知道何时会写到内存。但是如果对声明了<code>volatile</code>的变量进行写操作，JVM就会向处理器发送一条<code>Lock</code>前缀的指令，将这个变量在缓存行的数据写回到系统内存，但是，就算是写回到内存，如果其他处理器缓存的值还是旧值，再执行计算操作就会有问题，所以，在多处理器下，为了保证各个处理器的缓存是一致的，就会实现缓存一致性协议，每个处理器通过嗅探在总线上传播的数据来检查自己缓存的值是否过期了，当处理发现自己缓存行对应的内存地址被修改，就会将当前处理器缓存行设置成无效状态，当处理器对这个数据进行修改操作的时候，会重新从系统内存中把数据读到数据缓存里</p>
</blockquote>
<h6 id="2-volatile使用优化"><a href="#2-volatile使用优化" class="headerlink" title="2. volatile使用优化"></a>2. <code>volatile</code>使用优化</h6><blockquote>
<p>JDK7中<code>LinkedTransferQueue</code>类中使用了一种追加字节的方式来优化队列出队和入队的性能。</p>
</blockquote>
<ol>
<li><p>追加字节优化性能</p>
<blockquote>
<p>一个对象的引用占用4个字节，追加了15个变量(60字节)，所以一共有64个字节</p>
</blockquote>
</li>
<li><p>追加64字节后可以提高并发效率</p>
<blockquote>
<p>对于core i7等处理器的L1、L2、L3缓存的高速缓存行是64个字节宽，不支持部分填充缓存行，这意味着，如果队列的头结点和尾结点都不足64位，处理器会将其读到同一个高速缓存中，多处理器中每个处理器都会缓存同样的头、尾结点，当一个处理器试图修改头结点时，会锁定整个缓存行，在缓存一致性作用下，会导致其他处理器不能访问自己高速缓存中的尾节点，队列的入队和出队操作会不停修改头结点和尾节点，此时会严重影响出队和入队效率。追加字节后头、尾节点在修改时不会互相锁定</p>
</blockquote>
</li>
<li><p>不是在使用<code>volatile</code>变量时都应该追加字节</p>
<ul>
<li>缓存行非64位的处理器，例如奔腾系列</li>
<li>共享变量不会被频繁地写，追加字节会带来一定的性能消耗，如果不频繁的被写，则没必要追加字节</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://www.effiu.cn/2019/04/02/essay/linux_cmd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="effiu">
      <meta itemprop="description" content="effiu的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="effiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/04/02/essay/linux_cmd/" class="post-title-link" itemprop="url">linux 命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-02 17:46 17:46:00" itemprop="dateCreated datePublished" datetime="2019-04-02T17:46:00+08:00">2019-04-02 17:46</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-07-23 16:56 16:56:41" itemprop="dateModified" datetime="2019-07-23T16:56:41+08:00">2019-07-23 16:56</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          
            <span id="/blog/2019/04/02/essay/linux_cmd/" class="post-meta-item leancloud_visitors" data-flag-title="linux 命令" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>linux 命令</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2019/04/02/essay/linux_cmd/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://www.effiu.cn/2019/04/01/concurrent/1_challenges/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="effiu">
      <meta itemprop="description" content="effiu的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="effiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/04/01/concurrent/1_challenges/" class="post-title-link" itemprop="url">并发编程的挑战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-01 21:41 21:41:50" itemprop="dateCreated datePublished" datetime="2019-04-01T21:41:50+08:00">2019-04-01 21:41</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-02 00:54 00:54:36" itemprop="dateModified" datetime="2019-09-02T00:54:36+08:00">2019-09-02 00:54</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrent/" itemprop="url" rel="index"><span itemprop="name">concurrent</span></a>
                </span>
            </span>

          
            <span id="/blog/2019/04/01/concurrent/1_challenges/" class="post-meta-item leancloud_visitors" data-flag-title="并发编程的挑战" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>并发编程的目的是为了让程序运行更快，但是并不是启动更多的线程就能让程序更大限度并发执行。如果想通过多线程执行任务使程序运行得更快，会面临很多挑战。<strong>上下文切换问题、死锁问题，以及受限于硬件和软件的资源限制问题</strong></p>
</blockquote>
<h6 id="1-上下文切换"><a href="#1-上下文切换" class="headerlink" title="1. 上下文切换"></a>1. 上下文切换</h6><blockquote>
<p>即使单核处理器也支持多线程执行代码，CPU通过给每个线程分配CPU时间片实现。一般是几十毫秒(ms)</p>
</blockquote>
<ol>
<li>多线程并不一定快<blockquote>
<p><a target="_blank" rel="noopener" href="https://dev.tencent.com/u/effiu/p/essay-project/git/blob/master/src/main/java/com/essay/concurrent/learn/chapter1/ConcurrencyTest.java">代码</a></p>
</blockquote>
</li>
</ol>
<table>
<thead>
<tr>
<th>循环次数</th>
<th>串行执行</th>
<th>并发执行</th>
</tr>
</thead>
<tbody><tr>
<td>10亿</td>
<td>1250ms</td>
<td>1000ms</td>
</tr>
<tr>
<td>1亿</td>
<td>155ms</td>
<td>220ms</td>
</tr>
<tr>
<td>10万</td>
<td>4 ms</td>
<td>110ms</td>
</tr>
</tbody></table>
<h6 id="2-如何减少上下文切换"><a href="#2-如何减少上下文切换" class="headerlink" title="2. 如何减少上下文切换"></a>2. 如何减少上下文切换</h6><blockquote>
<p>减少上下文切换的方法有无锁并发编程、CAS算法、使用少线程和使用协程</p>
</blockquote>
<ul>
<li>无锁并发编程。多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一些办法避免上下文切换，例如将数据ID按照Hash算法取模分段，不同的线程处理不同段的数据 </li>
<li>CAS算法。Java的Atomic包使用CAS算法来更新数据，而不需要加锁</li>
<li>使用最少线程。避免创建不必要的线程。</li>
<li>协程。单线程实现多任务的调度，并在单线程里维持多个任务间的切换</li>
</ul>
<blockquote>
<p>减少上下文切换</p>
</blockquote>
<ol>
<li><p>查看当前Java进程PID</p>
</li>
<li><p>jstack pid 查看当前Java进程的线程,以下是部分线程信息</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@vdevops opt]# jstack 27568</span><br><span class="line"><span class="number">2018</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">04</span>:<span class="number">10</span></span><br><span class="line"><span class="function">Full thread dump Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server <span class="title">VM</span> <span class="params">(<span class="number">25.144</span>-b01 mixed mode)</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&quot;Attach Listener&quot; #42 daemon prio</span>=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f708c007000</span> nid=<span class="number">0x8f6</span> waiting on condition [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;ajp-nio-8009-Acceptor-0&quot; #40 daemon prio=5 os_prio=0 tid=0x00007f70b4499000 nid=0x6bd8 runnable [0x00007f70828e7000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">    at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)</span><br><span class="line">    at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:<span class="number">422</span>)</span><br><span class="line">    at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:<span class="number">250</span>)</span><br><span class="line">    - locked &lt;<span class="number">0x00000000f5fceae8</span>&gt; (a java.lang.Object)</span><br><span class="line">    at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:<span class="number">692</span>)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">&quot;ajp-nio-8009-ClientPoller-0&quot; #39 daemon prio=5 os_prio=0 tid=0x00007f70b4497000 nid=0x6bd7 runnable [0x00007f70829e8000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">    at sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)</span><br><span class="line">    at sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:<span class="number">269</span>)</span><br><span class="line">    at sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:<span class="number">93</span>)</span><br><span class="line">    at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:<span class="number">86</span>)</span><br><span class="line">    - locked &lt;<span class="number">0x00000000f69cf4c8</span>&gt; (a sun.nio.ch.Util$<span class="number">3</span>)</span><br><span class="line">    - locked &lt;<span class="number">0x00000000f69cf4d8</span>&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">    - locked &lt;<span class="number">0x00000000f69cf480</span>&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line">    at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:<span class="number">97</span>)</span><br><span class="line">    at org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:<span class="number">1051</span>)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;VM Thread&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f70b406d800</span> nid=<span class="number">0x6bb2</span> runnable </span><br><span class="line"><span class="string">&quot;VM Periodic Task Thread&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f70b40b7000</span> nid=<span class="number">0x6bb9</span> waiting on condition </span><br><span class="line">JNI global references: <span class="number">259</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>统计线程分别处于的状态</p>
<blockquote>
<p><code>awk &#39;&#123;print $2$3$4$5&#125;&#39; | grep &#39;java.lang.Thread.State&#39; dump | sort | uniq -c</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>    java.lang.Thread.State: RUNNABLE</span><br><span class="line"><span class="number">1</span>    java.lang.Thread.State: TIMED_WAITING (on object monitor)</span><br><span class="line"><span class="number">1</span>    java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line"><span class="number">1</span>    java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line"><span class="number">2</span>    java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line"><span class="number">20</span>    java.lang.Thread.State: WAITING (parking)</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析线程，以及找到解决方案</p>
</li>
</ol>
<h6 id="3-死锁"><a href="#3-死锁" class="headerlink" title="3. 死锁"></a>3. 死锁</h6><blockquote>
<p>锁可能会引起死锁，会造成系统不可用，如下是一些避免死锁的办法</p>
</blockquote>
<ul>
<li>避免一个线程同时获取多个锁</li>
<li>避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源</li>
<li>尝试使用定时锁，使用<code>lock.tryLock(timeout)</code>替代使用内部锁机制</li>
<li>对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况</li>
</ul>
<h6 id="4-资源限制的挑战"><a href="#4-资源限制的挑战" class="headerlink" title="4. 资源限制的挑战"></a>4. 资源限制的挑战</h6><blockquote>
<p>指进行并发编程时，程序的执行速度受限于计算机硬件资源或者软件资源。硬件资源限制有带宽的上传/下载速度、硬盘的读写速度和CPU的处理速度。软件限制有数据库的连接和socket连接数等。</p>
</blockquote>
<ul>
<li>资源限制引发的问题：将代码执行速度加快的原则是将代码中串行执行的部分编程并行，但是某段代码由于资源限制，仍在串行执行，这时候程序就会因为上下文切换和资源调度运行更慢。</li>
<li>解决资源限制的问题：硬件资源限制，可以考虑使用集群并发执行程序。软件资源限制，可以使用资源池复用。</li>
<li>在资源限制的情况下进行并发编程：根据不同的资源限制调整程序的并发度，例如下载文件依赖于带宽和硬盘读写速度。</li>
</ul>
<h6 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h6><blockquote>
<p>多使用JDK并发包提供的并发容器和工具类解决并发问题</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/8/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><span class="page-number current">9</span>
  </nav>



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18062655号 </a>
      <img src="https://images.effiu.cn/gongan.png" style="display: inline-block;">
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">effiu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">549k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">8:19</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  




  
<script src="/blog/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: location.pathname,
    }, {"enable":true,"appId":"Jw6tthQmGwY5Sc2OlYBjIePr-gzGzoHsz","appKey":"CjWG9xugjMIBiCz8MsGnH9WI","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"language":null,"visitor":true,"comment_count":false,"recordIP":false,"serverURLs":null}
    ));
  }, window.Valine);
});
</script>

</body>
</html>
